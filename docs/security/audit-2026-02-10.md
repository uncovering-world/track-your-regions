# Security Audit Report — 2026-02-10

## Summary

- **Total requirements checked**: 64
- **Pass**: 64 | **Fail**: 0 | **Partial**: 0 | **N/A**: 0
- **Critical findings**: 4 (High severity), all 4 fixed same-day
- **Second-pass findings**: 8 additional items (0 ASVS failures — all are defense-in-depth or code quality)
- **Same-day fixes**: All 4 critical findings + V1.2.2, V1.2.6, V2.2.1, V2.4.1, V3.4.1, V3.5.1, V4.1.2, V4.1.3, V5.2.1, V5.3.2, V6.1.1, V6.2.2, V6.2.3, V6.2.4, V6.2.12, V6.4.1, V6.5.1, V7.3.4, V7.3.5, V7.3.6, V7.3.7, V8.2.1, V9.2.3, V9.2.4, V13.4.1, V13.4.2

## Critical Findings

### 1. No Rate Limiting on Authentication Endpoints — HIGH — FIXED

**ASVS**: V2.2.1, V4.1.2, V6.1.1
**Files**: `backend/src/routes/authRoutes.ts`

No `express-rate-limit` or equivalent middleware existed. Login, registration, and refresh token endpoints accepted unlimited requests.

**Fix applied**: Installed `express-rate-limit` with per-route limiters:
- Login: 10 attempts / 15 minutes per IP
- Registration: 5 / hour per IP
- Refresh: 30 / minute per IP
- Uses `draft-7` standard headers (`RateLimit-Policy`, `RateLimit`)

---

### 2. OAuth Tokens Exposed in URL Parameters — HIGH — FIXED

**ASVS**: V14.3.2
**File**: `backend/src/routes/authRoutes.ts`

After Google/Apple OAuth, both `accessToken` and `refreshToken` were passed via URL query parameters.

**Fix applied**: Implemented one-time authorization code exchange. OAuth callbacks now redirect with an opaque code (32 random bytes, 60s TTL). Frontend exchanges the code via `POST /api/auth/exchange-code`, which returns the access token in the body and sets the refresh token as an httpOnly cookie.

---

### 3. Refresh Token Stored in localStorage — HIGH — FIXED

**ASVS**: V7.3.3, V14.3.1
**Files**: `frontend/src/hooks/useAuth.tsx`, `backend/src/routes/authRoutes.ts`

The 7-day refresh token was stored in `localStorage` under `tyr-refresh-token`, making it accessible to any XSS attack.

**Fix applied**: Refresh token is now set as an `httpOnly`, `Secure` (in production), `SameSite=Strict` cookie scoped to `/api/auth`. Frontend no longer stores or reads refresh tokens from localStorage (migration cleanup removes any leftover). The refresh endpoint reads from the cookie automatically.

---

### 4. JWT Algorithm Not Explicitly Restricted — HIGH — FIXED

**ASVS**: V9.1.2
**File**: `backend/src/services/authService.ts:63`

`jwt.verify(token, JWT_SECRET)` was called without an `algorithms` option. While `jsonwebtoken` v9+ rejects `none` when a secret is present, not specifying `algorithms: ['HS256']` left the door open to algorithm confusion attacks if the system ever migrated to asymmetric keys.

**Fix applied**: Added `{ algorithms: ['HS256'] }` to `jwt.verify()`.

---

## Chapter Results

### V1 — Encoding & Sanitization (6 checks)

| ID | Description | Status |
|----|-------------|--------|
| V1.2.1 | Output encoding for HTTP responses | **Pass** |
| V1.2.2 | URL encoding, safe protocols only | **Pass** — unsafe URL schemes blocked server-side (**fixed**) |
| V1.2.3 | JavaScript/JSON content encoding | **Pass** |
| V1.2.4 | Parameterized queries | **Pass** — all 350+ queries use `$N` placeholders |
| V1.2.5 | OS command injection protection | **Pass** |
| V1.2.6 | SPARQL injection protection | **Pass** — lat/lng validated: finite, bounds-checked (-90/90, -180/180) (**fixed**) |

### V2 — Validation & Business Logic (3 checks)

| ID | Description | Status |
|----|-------------|--------|
| V2.2.1 | Anti-automation controls | **Pass** — `express-rate-limit` on auth endpoints (**fixed**) |
| V2.3.1 | Server-side business logic | **Pass** |
| V2.4.1 | Input validation on all endpoints | **Pass** — Zod schemas on all 9 route files (body, query, params) (**fixed**) |

### V3 — Web Frontend Security (8 checks)

| ID | Description | Status |
|----|-------------|--------|
| V3.2.1 | Content rendering controls | **Pass** |
| V3.2.2 | Text rendered safely (no raw HTML) | **Pass** |
| V3.4.1 | HSTS header | **Pass** — max-age=31536000, includeSubDomains, preload (**fixed**) |
| V3.4.2 | CORS fixed origin | **Pass** |
| V3.4.4 | X-Content-Type-Options | **Pass** |
| V3.4.5 | Referrer-Policy | **Pass** |
| V3.4.6 | frame-ancestors CSP | **Pass** |
| V3.5.1 | CSRF protection | **Pass** — Origin header check + SameSite=Strict cookie + JWT in header (**fixed**) |
| V3.5.3 | HTTP methods match operations | **Pass** |

### V4 — API & Web Service (4 checks)

| ID | Description | Status |
|----|-------------|--------|
| V4.1.1 | CORS configured | **Pass** |
| V4.1.2 | Rate limiting | **Pass** — auth + search + geocode endpoints rate-limited (**fixed**) |
| V4.1.3 | No data leaks in responses | **Pass** — 500 errors masked in production (**fixed**) |
| V4.1.4 | Request body size limits | **Pass** |

### V5 — File Handling (4 checks)

| ID | Description | Status |
|----|-------------|--------|
| V5.2.1 | Download size limits | **Pass** — Content-Length pre-check + 20MB stream limit (**fixed**) |
| V5.2.2 | Content-type validation | **Pass** |
| V5.3.1 | Files not in executable paths | **Pass** |
| V5.3.2 | No user-controlled paths | **Pass** |

### V6 — Authentication (14 checks)

| ID | Description | Status |
|----|-------------|--------|
| V6.1.1 | Rate limiting on auth | **Pass** — `express-rate-limit` added (**fixed**) |
| V6.2.1 | Min password length (8) | **Pass** |
| V6.2.2 | Password change capability | **Pass** — `POST /api/auth/change-password` (**fixed**) |
| V6.2.3 | Change requires current password | **Pass** — bcrypt-verified before update (**fixed**) |
| V6.2.4 | Common password check | **Pass** — HIBP k-Anonymity API on register + password change (**fixed**) |
| V6.2.5 | No composition rules | **Pass** |
| V6.2.6 | type=password on inputs | **Pass** |
| V6.2.7 | Paste/password managers allowed | **Pass** |
| V6.2.8 | Password as-is (no truncation) | **Pass** |
| V6.2.9 | Max length >= 64 | **Pass** (128) |
| V6.2.12 | Breached password check | **Pass** — HIBP k-Anonymity API (privacy-preserving) (**fixed**) |
| V6.3.1 | Approved hashing algorithm | **Pass** (bcrypt 12) |
| V6.4.1 | Email verification | **Pass** — full flow: register sends token, verify-email endpoint verifies + auto-login, 24h expiry, resend endpoint (**fixed**) |
| V6.5.1 | Credential enumeration resistance | **Pass** — register always returns identical response; resend-verification also uniform (**fixed**) |

### V7 — Session Management (7 checks)

| ID | Description | Status |
|----|-------------|--------|
| V7.2.1 | Cryptographically random tokens | **Pass** |
| V7.3.1 | Session timeout | **Pass** (15min access, 7d refresh) |
| V7.3.2 | Refresh token rotation | **Pass** |
| V7.3.3 | Secure token storage | **Pass** — httpOnly cookie (**fixed**) |
| V7.3.4 | Reuse detection | **Pass** — token family tracking; reused token revokes entire family (**fixed**) |
| V7.3.5 | Logout invalidation | **Pass** — refresh token revoked + access token JTI blacklisted in-memory (**fixed**) |
| V7.3.6 | Concurrent session limits | **Pass** — max 10 refresh tokens per user, oldest revoked (**fixed**) |
| V7.3.7 | Token cleanup | **Pass** — `cleanup_refresh_tokens()` scheduled every 6 hours (**fixed**) |

### V8 — Authorization (3 checks)

| ID | Description | Status |
|----|-------------|--------|
| V8.2.1 | Server-side authorization | **Pass** — `requireAdmin` added to SSE endpoint (**fixed**) |
| V8.3.1 | IDOR protection | **Pass** — `/me/` pattern throughout |
| V8.3.2 | Curator scope enforcement | **Pass** |

### V9 — Self-Contained Tokens (6 checks)

| ID | Description | Status |
|----|-------------|--------|
| V9.1.1 | Signature/MAC validation | **Pass** |
| V9.1.2 | Algorithm allowlist | **Pass** — `algorithms: ['HS256']` added (**fixed**) |
| V9.1.3 | Key from trusted source | **Pass** |
| V9.2.1 | exp/nbf verified | **Pass** |
| V9.2.2 | Token type differentiation | **Pass** (structural) |
| V9.2.3 | Audience (aud) validated | **Pass** — iss + aud claims added (**fixed**) |
| V9.2.4 | No sensitive data in JWT | **Pass** — only sub, uuid, role in payload; PII removed (**fixed**) |

### V13 — Configuration (3 checks)

| ID | Description | Status |
|----|-------------|--------|
| V13.3.1 | No hardcoded secrets | **Pass** |
| V13.4.1 | No sensitive error messages | **Pass** — 500 errors masked in production (**fixed**) |
| V13.4.2 | Production secret validation | **Pass** — throws on startup if JWT_SECRET missing in production (**fixed**) |

### V14 — Data Protection (3 checks)

| ID | Description | Status |
|----|-------------|--------|
| V14.2.1 | Sensitive data classified | **Pass** |
| V14.3.1 | Browser storage security | **Pass** — refresh token in httpOnly cookie (**fixed**) |
| V14.3.2 | Tokens not in URLs | **Pass** — one-time auth code exchange (**fixed**) |

## Additional Findings (Non-ASVS)

### F-01: SSE Geometry Compute Missing Admin Check — MEDIUM — FIXED

**File**: `backend/src/routes/worldViewRoutes.ts:123`

The SSE endpoint `computeSingleRegionGeometrySSE` was using only `requireAuth` but not `requireAdmin`. The non-SSE equivalent on line 122 correctly requires both.

**Fix applied**: Added `requireAdmin` to the middleware chain.

### F-02: Curation Log Lacks Scope Check — LOW — FIXED

**File**: `backend/src/controllers/experience/curationController.ts:432-458`

`getCurationLog` requires `requireCurator` but didn't call `checkCuratorScope`. Any curator could view any experience's curation log regardless of their assigned scope.

**Fix applied**: Added `checkCuratorScope` check — looks up the experience's first region and source, then verifies the curator has permission before returning the log.

### F-03: editExperience Passes Null regionId — LOW

**File**: `backend/src/controllers/experience/curationController.ts:334`

When an experience has no region assignments, `regionId` is `null` but `checkCuratorScope` expects `number`. Fails closed (denies access), so not exploitable, but TypeScript signature should be `number | null`.

### F-04: Image Downloads Lack Size Limit — MEDIUM — FIXED

**File**: `backend/src/services/sync/imageService.ts`

No `Content-Length` check or stream size limit on downloaded images. If a remote server sends unbounded data, it could exhaust disk space or memory.

**Fix applied**: Added Content-Length pre-check and a 20MB Transform stream limit. Downloads exceeding the limit are rejected upfront (if Content-Length is provided) or aborted mid-stream.

### F-05: externalId Not Sanitized in Image File Paths — MEDIUM — FIXED

**File**: `backend/src/services/sync/imageService.ts:37-39`

`sourceName` was sanitized (`replace(/[^a-z0-9]/g, '-')`), but `externalId` was used directly in the file path (`${externalId}.jpg`).

**Fix applied**: Added `replace(/[^a-zA-Z0-9_-]/g, '-')` sanitization to `externalId` in both `getImagePath()` and `getImageUrl()`.

### F-06: GHCR PAT in Local deployment/.env — LOW

**Files**: `deployment/.env:31`, `deployment/.env.development:31`

A GitHub Personal Access Token with `write:packages` scope is present in local deployment config files. These files are correctly excluded by `.gitignore` and were **never committed to git history** (verified). Risk is limited to local machine compromise, but tokens in files are harder to rotate than tokens in a secrets manager.

**Recommendation**: Move to a CI-only environment variable or secrets manager. Verify the token's scope is minimal.

---

## Second-Pass Findings (Post Email Verification)

After implementing email verification (closing V6.4.1 and V6.5.1), a second audit pass identified these additional items. None are ASVS requirement failures — they are defense-in-depth improvements and code quality issues.

### F-07: Double Refresh Token Creation in /refresh — MEDIUM (Bug) — FIXED

**File**: `backend/src/routes/authRoutes.ts:342-350`

The `/refresh` endpoint was creating **two** refresh tokens per rotation:
1. `rotateRefreshToken(refreshToken)` → revokes old token, creates new one via `createRefreshToken()`
2. `generateTokenPair(user)` → calls `createRefreshToken()` **again**, creating a second orphaned token

Only the token from `rotateRefreshToken` was sent to the client. The second was orphaned in the DB.

**Fix applied**: Replaced `generateTokenPair(user)` with `generateAccessToken(user)` since the refresh token is already created by `rotateRefreshToken()`.

### F-08: No Rate Limit on /verify-email — LOW — FIXED

**File**: `backend/src/routes/authRoutes.ts:260`

The `/verify-email` endpoint had no rate limiter. Mitigated by 256-bit token entropy, but rate limiting prevents request flooding.

**Fix applied**: Added `verifyEmailLimiter` (10/minute per IP).

### F-09: No Rate Limit on /exchange-code — LOW — FIXED

**File**: `backend/src/routes/authRoutes.ts:491`

The OAuth code exchange endpoint had no rate limiter. Mitigated by 256-bit code entropy and 60-second TTL.

**Fix applied**: Added `exchangeCodeLimiter` (10/minute per IP).

### F-10: Login Timing Oracle — LOW — FIXED

**File**: `backend/src/auth/strategies/local.ts:19-29`

When the user was not found, the function returned immediately. When found, it performed a bcrypt compare (~200ms with 12 rounds). This timing difference could be measured over the network to determine whether an email exists.

**Fix applied**: Added a dummy `bcrypt.compare()` against a pre-computed hash when user is not found, equalizing response timing.

### F-11: Login Leaks EMAIL_NOT_VERIFIED Status — LOW (Accepted Trade-off)

**File**: `backend/src/routes/authRoutes.ts:220-224`

After a successful password match, unverified accounts receive a 403 with `code: "EMAIL_NOT_VERIFIED"`. This confirms: (a) the email exists, (b) the password is correct. This is a deliberate UX trade-off — the frontend needs this code to show a "Resend verification email" option. The information leakage is limited to an attacker who already knows the correct password.

**Status**: Accepted trade-off. Rate limiting (10/15min) constrains exploitation.

### F-12: OAuth Auto-Linking Without Password Proof — LOW

**File**: `backend/src/auth/strategies/google.ts:48-63`

When a Google account's email matches an existing verified local account, it auto-links without requiring password confirmation. This allows an attacker who controls a Google account with the target's email to access the local account. Mitigated by requiring the local account to be email-verified first (an attacker can't register + verify someone else's email).

**Recommendation**: Consider requiring password confirmation on first OAuth link to an existing local account.

### F-13: Verification Token Operations Not Transactional — LOW

**File**: `backend/src/services/authService.ts:387-415`

`verifyEmailToken()` performs SELECT → UPDATE → DELETE as three separate queries without a transaction. A race condition could cause the token to be verified twice (two concurrent requests). Mitigated by the fact that the second DELETE would find nothing, and `email_verified = true` is idempotent.

**Recommendation**: Wrap in a transaction for correctness, or use a single `UPDATE ... RETURNING` + `DELETE` to make it atomic.

### F-14: z.any() for GeoJSON Geometry Fields — LOW

**File**: `backend/src/types/index.ts:404,436,471,481,483`

Five Zod schemas use `z.any()` for GeoJSON geometry fields. These are admin-only endpoints (requires `requireAdmin`), so the attack surface is limited to compromised admin accounts.

**Recommendation**: Add a GeoJSON Zod schema that validates the structure (type + coordinates array). Not urgent given admin-only access.

---

## Recommendations (Priority Order)

### Immediate (address before next release)

1. ~~**Add `express-rate-limit`** to auth endpoints (login, register, refresh)~~ — **DONE**
2. ~~**Add `algorithms: ['HS256']`** to `jwt.verify()` in `authService.ts`~~ — **DONE**
3. ~~**Add `requireAdmin`** to SSE geometry compute endpoint~~ — **DONE**
4. ~~**Validate `websiteUrl` scheme** — reject `javascript:`, `data:`, `vbscript:` in curator URLs~~ — **DONE**
5. ~~**Sanitize `externalId`** in image file path construction~~ — **DONE**

### Short-term (next sprint)

6. ~~**Move refresh token** from localStorage to httpOnly cookie~~ — **DONE**
7. ~~**Replace OAuth token-in-URL** with one-time code exchange~~ — **DONE**
8. ~~**Add JWT claims**: `iss` (issuer) and `aud` (audience) to sign/verify~~ — **DONE**
9. ~~**Implement password change endpoint** (`POST /api/auth/change-password`)~~ — **DONE**
10. ~~**Add common password check** (top 10K list or HIBP k-Anonymity API)~~ — **DONE**
11. ~~**Add Zod schemas** to experience, curation, region, and geocode endpoints~~ — **DONE**
12. ~~**Make JWT_SECRET check fatal** in production (throw, not warn)~~ — **DONE**
13. ~~**Validate lat/lng bounds** in geocode SPARQL queries (-90/90, -180/180)~~ — **DONE**
14. ~~**Add download size limit** to imageService~~ — **DONE**

### Medium-term (backlog)

15. ~~**Implement email verification** flow for local accounts~~ — **DONE**
16. ~~**Add token family tracking** for refresh token reuse detection~~ — **DONE**
17. ~~**Schedule `cleanup_refresh_tokens()`** via cron or application timer~~ — **DONE**
18. ~~**Implement concurrent session limits** (max 10 refresh tokens per user)~~ — **DONE**
19. ~~**Add `checkCuratorScope`** to getCurationLog~~ — **DONE**
20. ~~**Mask `err.message`** on 500 errors in production (return generic message)~~ — **DONE**
21. ~~**Remove email/displayName** from JWT payload (fetch via `/me` endpoint)~~ — **DONE**
22. **Consider one-time ticket** pattern for SSE authentication instead of JWT in query params

### Second-pass items (defense-in-depth)

23. ~~**Fix double refresh token in /refresh** — use `generateAccessToken()` instead of `generateTokenPair()` (F-07)~~ — **DONE**
24. ~~**Add rate limiting** to `/verify-email` and `/exchange-code` endpoints (F-08, F-09)~~ — **DONE**
25. ~~**Add dummy bcrypt** on login when user not found to prevent timing oracle (F-10)~~ — **DONE**
26. **Wrap `verifyEmailToken()`** in a database transaction (F-13)
27. **Add GeoJSON Zod schema** to replace `z.any()` on geometry fields (F-14)
28. **Consider password confirmation** for first OAuth link to existing local account (F-12)

---

## Strengths

The codebase has a strong security foundation:

- **SQL injection**: Excellent — 350+ parameterized queries, no string concatenation in SQL
- **IDOR protection**: Excellent — consistent `/me/` pattern, never accepts user IDs from URLs
- **Password hashing**: Strong — bcrypt with cost factor 12, HIBP breach check
- **CORS**: Properly configured single-origin with credentials
- **XSS**: Strong — React auto-escaping, no unsafe HTML rendering, Helmet headers
- **Curator scopes**: Well-designed hierarchical scope system with recursive CTE
- **Refresh token rotation**: Properly implemented with server-side hashing and family tracking
- **File path sanitization**: Consistent sanitization of filesystem paths
- **Email verification**: Full flow with anti-enumeration, 24h token expiry, console transport for dev
- **JWT hardening**: HS256 only, iss/aud claims, no PII, JTI blacklist on logout
- **Rate limiting**: Comprehensive — auth, search, geocode, and resend endpoints all rate-limited
- **Input validation**: Zod schemas on all 9 route files (body, query, params)
