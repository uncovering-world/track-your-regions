# Geometry Columns Reference

This document describes all geometry columns in the database, their relationships, and when each is used.

## `regions` table (8 geometry columns)

User-defined regions within world views (continents, sub-regions, etc.).

### Source geometries (SRID 4326 — WGS84 lat/lon)

| Column | Type | Description |
|--------|------|-------------|
| `geom` | MultiPolygon | **Primary geometry**. Computed by merging member division geometries. This is the authoritative shape. |
| `ts_hull_geom` | MultiPolygon | **Concave hull** generated by TypeScript for archipelago regions. Provides a cleaner outline than the raw merged geometry for scattered island groups. |
| `anchor_point` | Point | Label anchor point for the region on the map. Auto-computed by trigger. |
| `focus_bbox` | double precision[4] | Pre-computed bounding box `[west, south, east, north]` for `fitBounds()`. West > east indicates antimeridian crossing. Auto-computed by trigger. |

### Derived 3857 geometries (SRID 3857 — Web Mercator)

Auto-maintained by the `trg_regions_geom_3857` trigger whenever source geometries change.

| Column | Type | Derived from | Description |
|--------|------|-------------|-------------|
| `geom_3857` | MultiPolygon | `geom` | Full-resolution geometry in Web Mercator for MVT generation. |
| `ts_hull_geom_3857` | MultiPolygon | `ts_hull_geom` | Full-resolution hull in Web Mercator. |
| `geom_simplified_low` | MultiPolygon | Best of: `ts_hull_geom_3857` > `geom_3857` | **Zoom 0-4**. Simplified with 5km tolerance, no smoothing. |
| `geom_simplified_medium` | MultiPolygon | Same priority | **Zoom 5-8**. Simplified with 1km tolerance, no smoothing. |

> Note: Despite lacking `_3857` in the name, `geom_simplified_low` and `geom_simplified_medium` are stored in SRID 3857.

### Render geometry selection

The render geometry (what to draw on the map) is a simple choice:

```
IF archipelago AND ts_hull_geom IS NOT NULL → ts_hull_geom
ELSE → geom
```

This logic is centralized in the `region_render_geom` database view.

### Selection priority in tile functions

The Martin tile functions choose geometry based on zoom level and region type:

```
Zoom 0-2:  extra-simplified geom_simplified_low
Zoom 3-4:  geom_simplified_low
Zoom 5-8:  geom_simplified_medium
Zoom 9+:   ts_hull_geom_3857 (archipelagos), else geom_3857
```

---

## `administrative_divisions` table (8 geometry columns)

GADM administrative boundaries (countries, states, provinces, etc.).

### Source geometries (SRID 4326)

| Column | Type | Description |
|--------|------|-------------|
| `geom` | MultiPolygon | **Primary geometry** from GADM data. Full-resolution boundary. |
| `geom_simplified_low` | MultiPolygon | Simplified in 4326 by init-db.py (0.1° tolerance). Used for GeoJSON API responses. |
| `geom_simplified_medium` | MultiPolygon | Simplified in 4326 by init-db.py (0.01° tolerance). Used for GeoJSON API responses. |
| `anchor_point` | Point | Label anchor point. |

### Derived 3857 geometries (SRID 3857)

Auto-maintained by the `trg_admin_div_geom_3857` trigger.

| Column | Type | Derived from | Description |
|--------|------|-------------|-------------|
| `geom_3857` | MultiPolygon | `geom` | Full-resolution in Web Mercator. |
| `geom_simplified_low_3857` | MultiPolygon | `geom_3857` (re-simplified in 3857) | **Zoom 0-4**. 5km tolerance, no smoothing (shared borders must align). |
| `geom_simplified_medium_3857` | MultiPolygon | `geom_3857` (re-simplified in 3857) | **Zoom 5-8**. 1km tolerance, no smoothing (shared borders must align). |

> Note: The `_3857` simplified columns are re-simplified from `geom_3857` using meter-based tolerance (consistent at all latitudes), not just transformed from the 4326 simplified versions.

### Selection priority in tile functions

```
Zoom 0-4:  geom_simplified_low_3857
Zoom 5-8:  geom_simplified_medium_3857
Zoom 9+:   geom_3857
```

---

## `region_members` table

Links regions to admin divisions, with optional partial geometry override.

| Column | Type | Description |
|--------|------|-------------|
| `custom_geom` | Geometry | Optional partial geometry override for when a division is split across regions. |
| `custom_name` | text | Optional name override for the member. |

The **member effective geometry** is `COALESCE(rm.custom_geom, ad.geom)` — use the partial override if drawn, otherwise the full division geometry. This logic is centralized in the `region_member_effective_geom` database view.

---

## Database views

Two views centralize geometry resolution logic to prevent bugs from scattered COALESCE/CASE patterns:

| View | Purpose |
|------|---------|
| `region_member_effective_geom` | Resolves `COALESCE(rm.custom_geom, ad.geom)` for each member. Includes `is_partial` flag and effective name. |
| `region_render_geom` | Resolves archipelago hull vs real geometry for each region. Provides `render_geom` column. |

---

## Geometry concepts

The system has exactly 4 geometry concepts:

| Concept | Where | What it is |
|---------|-------|------------|
| **Division geometry** | `administrative_divisions.geom` | GADM polygon. Immutable source data |
| **Member effective geometry** | `COALESCE(member.custom_geom, division.geom)` | What a member contributes to its region. Uses partial override if drawn, otherwise the full division |
| **Region real geometry** | `regions.geom` | Computed union of all member effective geometries. Used for spatial operations (containment, assignment, area) |
| **Region hull** | `regions.ts_hull_geom` | Concave hull for archipelago visualization. Makes scattered islands visible on the map |

---

## When each geometry is used

| Context | Table | Column(s) used |
|---------|-------|---------------|
| Martin vector tiles (zoom 0-2) | regions | extra-simplified `geom_simplified_low` |
| Martin vector tiles (zoom 0-4) | regions | `geom_simplified_low` |
| Martin vector tiles (zoom 0-4) | admin_div | `geom_simplified_low_3857` |
| Martin vector tiles (zoom 5-8) | regions | `geom_simplified_medium` |
| Martin vector tiles (zoom 5-8) | admin_div | `geom_simplified_medium_3857` |
| Martin vector tiles (zoom 9+) | regions | `ts_hull_geom_3857` (archipelagos), else `geom_3857` |
| Martin vector tiles (zoom 9+) | admin_div | `geom_3857` |
| GeoJSON API `/geometry?detail=low` | admin_div | `geom_simplified_low` (4326) |
| GeoJSON API `/geometry?detail=medium` | admin_div | `geom_simplified_medium` (4326) |
| GeoJSON API `/geometry?detail=high` | admin_div | `geom` (4326) |
| Geometry computation (region merging) | regions | `geom` (4326) |
| Camera fly-to (fitBounds) | regions | `focus_bbox` (array of 4 doubles) |
| Map labels | both | `anchor_point` (4326) |

## How geometries are maintained

- **GADM divisions**: Loaded by `db/init-db.py` which inserts `geom` and simplified 4326 versions. The `trg_admin_div_geom_3857` trigger auto-computes all 3857 columns.
- **Regions**: Created/updated by the backend API when geometry is computed. The `trg_regions_geom_3857` trigger auto-computes all 3857 and simplified columns.
- **Simplified columns**: Never written directly by application code. Always computed by triggers using `simplify_for_zoom()`.

## Simplification strategy

The `simplify_for_zoom(geom, tolerance, min_area, smooth_iterations)` function uses a three-stage pipeline:

1. **Stage 1 — Simplify**: `ST_Simplify` at requested tolerance (Douglas-Peucker, tolerance in meters), fix with `ST_MakeValid`, dump into individual polygons, drop polygons below `min_area`, re-collect into MultiPolygon
2. **Stage 2 — Fallback for small islands**: If Stage 1 produced NULL (geometry smaller than tolerance), retry with tolerance scaled to `max_polygon_width / 10`. This preserves small island regions like Aruba, Barbados, etc.
3. **Stage 3 — Smooth**: Apply `ST_ChaikinSmoothing` to round off the angular artifacts from Douglas-Peucker simplification

We use `ST_Simplify` instead of `ST_SimplifyPreserveTopology` because merged region
geometries (composed of many country borders) create topology constraints that prevent
vertex removal. `ST_Simplify` freely removes vertices, then `ST_MakeValid` repairs any
self-intersections. Chaikin smoothing (corner-cutting algorithm) rounds the angular
artifacts that Douglas-Peucker simplification produces.

| Zoom tier | Table | Tolerance | Min polygon area | Chaikin passes | Rationale |
|-----------|-------|-----------|-----------------|---------------|-----------|
| Low (0-4) | regions | 5,000m (5km) | 0 (no filter) | 0 | Same as admin_div — leaf regions share borders with neighbors. |
| Low (0-4) | admin_div | 5,000m (5km) | 0 (no filter) | 0 | Lower tolerance than regions — shared borders create gaps proportional to tolerance. 5km keeps gaps sub-pixel at zoom 3-4. |
| Medium (5-8) | regions | 1,000m (1km) | 0 (no filter) | 0 | Same as admin_div — leaf regions share borders with neighbors. |
| Medium (5-8) | admin_div | 1,000m (1km) | 0 (no filter) | 0 | High detail — sub-pixel gaps at zoom 5+. |
