# Geometry System Reference

This document describes the complete geometry system: core concepts, lifecycle from GADM import through map rendering, database schema, triggers, tile functions, and antimeridian handling.

## Core concepts

The system has exactly 4 geometry concepts:

| Concept | Where | What it is |
|---------|-------|------------|
| **Division geometry** | `administrative_divisions.geom` | GADM polygon. Immutable source data |
| **Member effective geometry** | `COALESCE(rm.custom_geom, ad.geom)` | What a member contributes to its region. Uses partial override if drawn, otherwise the full division |
| **Region real geometry** | `regions.geom` | Computed union of all member effective geometries. Used for spatial operations (containment, assignment, area) |
| **Region hull** | `regions.ts_hull_geom` | Concave hull for archipelago visualization. Makes scattered islands visible on the map |

The flow: GADM divisions are the raw data. Members link divisions to regions, optionally with custom partial geometry. Region geometry is the union of its members (and child regions). For archipelagos, a hull wraps the scattered islands into a clean outline.

---

## Lifecycle

### 1. GADM import (`db/init-db.py`)

Reads GADM GeoPackage files via GDAL/OGR and inserts divisions into `administrative_divisions`:

- **Leaf divisions** (districts, provinces) get `geom` set via `ST_Multi(ST_GeomFromWKB(..., 4326))`
- **Non-leaf divisions** (countries, continents) are inserted with `geom = NULL` initially
- On INSERT, trigger `trigger_simplify_geom` auto-generates `geom_simplified_low` (0.1° tolerance) and `geom_simplified_medium` (0.01° tolerance) using `ST_SimplifyPreserveTopology`
- Trigger `trg_admin_div_geom_3857` auto-generates all 3857 columns

Special handling during import:
- Single-child chains ("Berlin > Berlin > Berlin") are collapsed via `merge_single_children()`
- Redundant NAME_0 divisions are skipped when a next GADM level exists

### 2. Parent geometry computation (`db/precalculate-geometries.py`)

After import, non-leaf divisions need geometry by merging their children. Runs bottom-up (deepest first):

1. Find all non-leaf divisions without `geom`, ordered by depth
2. For each: `ST_Union()` all children's geometries
3. Adaptive simplification: targets 5k-10k points per division based on point density
4. Validates with `ST_MakeValid()`, extracts only polygons via `ST_CollectionExtract(..., 3)`

Result: all divisions have `geom` in SRID 4326. Simplified and 3857 columns auto-generated by triggers.

### 3. Region member assignment

`addDivisionsToRegion()` in `backend/src/controllers/worldView/regionMemberMutations.ts` inserts rows into `region_members`:

- `region_id` + `division_id` — the basic link
- `custom_geom` — optional partial geometry (GeoJSON) for when a user draws custom boundaries for part of a division
- `custom_name` — optional display name for the custom part
- No unique constraint: same division can appear multiple times with different `custom_geom` values

The effective geometry for any member is `COALESCE(rm.custom_geom, ad.geom)`, centralized in the `region_member_effective_geom` view.

### 4. Region geometry computation

`computeSingleRegionGeometry()` in `backend/src/controllers/worldView/geometryCompute.ts` computes `regions.geom`:

1. **Collect geometries** from:
   - Region members: `COALESCE(rm.custom_geom, ad.geom)` for each member
   - Child regions: `regions.geom` where `parent_region_id = this`
   - For large regions (>300k total points): pre-simplify at 0.005° before merging
2. **Snap to neighbors** (optional) — `ST_Snap(a.geom, neighbors.geom, 0.001)` aligns shared boundaries between child regions to prevent wavy borders
3. **Union** — `ST_UnaryUnion()` merges all geometries
4. **Clean** — filter holes <10 km², remove slivers (perimeter/sqrt(area) > 25), simplify at 0.0001°
5. **Write** to `regions.geom` — triggers fire (see Trigger Pipeline below)

### 5. Hull generation (archipelagos)

For archipelago regions, a concave hull provides a clean visual outline at low zoom. The hull system lives in `backend/src/services/hull/`.

**When hull is generated:**
- Via Admin UI: `POST /api/world-views/regions/:regionId/hull/save` with optional params
- During geometry compute: auto-generated for newly detected archipelagos (INSERT only)

**When hull is NULL:**
- Region is not an archipelago
- Hull hasn't been generated yet
- Hull was explicitly cleared

**Algorithm** (`hullCalculator.ts`):
1. Extract representative points from region geometry (one per polygon via `ST_PointOnSurface()`)
2. Detect dateline crossing: if points span >180° longitude
3. For dateline-crossing regions: split points into east/west groups, generate separate hulls clamped to [0,180] and [-180,0], align edges at ±180 so both polygons meet
4. For each point group: generate turf.js concave hull with `maxEdge = maxDimension * concavity`. If concave returns MultiPolygon, fall back to convex hull
5. Buffer the hull by `bufferKm` (default 50km), simplify at `simplifyTolerance` (default 0.02)

**Parameters** stored in `ts_hull_params` JSONB: `{ bufferKm, concavity, simplifyTolerance }` — preserved across regenerations.

**Display modes** in the World View editor:
- `real` — shows authoritative `geom` (union of member geometries)
- `ts_hull` — shows the concave hull for archipelagos

**API endpoints:**
- `POST /api/world-views/regions/:regionId/hull/preview` — preview hull with custom params
- `POST /api/world-views/regions/:regionId/hull/save` — save hull to database
- `GET /api/world-views/regions/:regionId/hull/params` — get current hull params
- `GET /api/world-views/regions/:regionId/geometry?detail=high|ts_hull|anchor` — read geometry

---

## Database schema

### `regions` table (8 geometry columns)

User-defined regions within world views (continents, sub-regions, etc.).

#### Source geometries (SRID 4326 — WGS84 lat/lon)

| Column | Type | Description |
|--------|------|-------------|
| `geom` | MultiPolygon | **Primary geometry**. Computed by merging member division geometries. This is the authoritative shape. |
| `ts_hull_geom` | MultiPolygon | **Concave hull** generated by TypeScript for archipelago regions. Provides a cleaner outline than the raw merged geometry for scattered island groups. |
| `anchor_point` | Point | Label anchor point for the region on the map. Auto-computed by trigger. |
| `focus_bbox` | double precision[4] | Pre-computed bounding box `[west, south, east, north]` for `fitBounds()`. West > east indicates antimeridian crossing. Auto-computed by trigger. |

#### Derived 3857 geometries (SRID 3857 — Web Mercator)

Auto-maintained by the `trg_regions_geom_3857` trigger whenever source geometries change.

| Column | Type | Derived from | Description |
|--------|------|-------------|-------------|
| `geom_3857` | MultiPolygon | `geom` | Full-resolution geometry in Web Mercator for MVT generation. |
| `ts_hull_geom_3857` | MultiPolygon | `ts_hull_geom` | Full-resolution hull in Web Mercator. |
| `geom_simplified_low` | MultiPolygon | Best of: `ts_hull_geom_3857` > `geom_3857` | **Zoom 0-4**. Simplified with 5km tolerance, no smoothing. |
| `geom_simplified_medium` | MultiPolygon | Same priority | **Zoom 5-8**. Simplified with 1km tolerance, no smoothing. |

> Note: Despite lacking `_3857` in the name, `geom_simplified_low` and `geom_simplified_medium` are stored in SRID 3857.

### `administrative_divisions` table (7 geometry columns)

GADM administrative boundaries (countries, states, provinces, etc.).

#### Source geometries (SRID 4326)

| Column | Type | Description |
|--------|------|-------------|
| `geom` | MultiPolygon | **Primary geometry** from GADM data. Full-resolution boundary. |
| `geom_simplified_low` | MultiPolygon | Simplified in 4326 (0.1° tolerance). Used for GeoJSON API responses. |
| `geom_simplified_medium` | MultiPolygon | Simplified in 4326 (0.01° tolerance). Used for GeoJSON API responses. |
| `anchor_point` | Point | Label anchor point. |

#### Derived 3857 geometries (SRID 3857)

Auto-maintained by the `trg_admin_div_geom_3857` trigger.

| Column | Type | Derived from | Description |
|--------|------|-------------|-------------|
| `geom_3857` | MultiPolygon | `geom` | Full-resolution in Web Mercator. |
| `geom_simplified_low_3857` | MultiPolygon | `geom_3857` (re-simplified in 3857) | **Zoom 0-4**. 5km tolerance, no smoothing. |
| `geom_simplified_medium_3857` | MultiPolygon | `geom_3857` (re-simplified in 3857) | **Zoom 5-8**. 1km tolerance, no smoothing. |

> Note: The `_3857` simplified columns are re-simplified from `geom_3857` using meter-based tolerance (consistent at all latitudes), not just transformed from the 4326 simplified versions.

### `region_members` table

Links regions to admin divisions, with optional partial geometry override.

| Column | Type | Description |
|--------|------|-------------|
| `custom_geom` | MultiPolygon | Optional partial geometry override for when a division is split across regions. |
| `custom_name` | text | Optional name override for the member. |

The **member effective geometry** is `COALESCE(rm.custom_geom, ad.geom)` — use the partial override if drawn, otherwise the full division geometry.

### Database views

Two views centralize geometry resolution logic to prevent bugs from scattered COALESCE/CASE patterns:

| View | Purpose |
|------|---------|
| `region_member_effective_geom` | Resolves `COALESCE(rm.custom_geom, ad.geom)` for each member. Includes `is_partial` flag and effective name. |
| `region_render_geom` | Resolves archipelago hull vs real geometry for each region. Provides `render_geom` column. |

These views are defined in `db/init/01-schema.sql` (lines 190-211). They are available for use in queries but backend code currently uses inline COALESCE/CASE patterns in most places (gradual migration planned).

---

## Trigger pipeline

### Regions — 3 triggers on geometry changes

All three are BEFORE triggers, so they fire in alphabetical order by trigger name within each event:

#### 1. `trigger_region_metadata` (on INSERT or UPDATE OF geom)

```
update_region_metadata()
  → geom_area_km2 = ST_Area(geom::geography) / 1e6
  → is_archipelago: auto-detected on INSERT only (preserved on UPDATE)
```

Archipelago detection uses `is_archipelago_geometry()`: requires ≥10 separate polygon parts with sparsity >200 (or ≥100 parts with sparsity >100 and area_per_part <0.2).

#### 2. `trigger_update_region_focus_data` (on INSERT or UPDATE OF geom, ts_hull_geom)

```
update_region_focus_data()
  → effective_geom = COALESCE(ts_hull_geom, geom)
  → Computes anchor_point and focus_bbox
  → Three-branch antimeridian logic (see Antimeridian Handling section)
```

This trigger fires on both `geom` and `ts_hull_geom` changes because the hull affects the bounding box.

#### 3. `trg_regions_geom_3857` (on INSERT or UPDATE — any column)

```
update_regions_geom_3857()
  → IF geom changed: geom_3857 = ST_Transform(geom, 3857) + ST_MakeValid
  → IF ts_hull_geom changed: ts_hull_geom_3857 = ST_Transform(ts_hull_geom, 3857) + ST_MakeValid
  → IF either changed: simplify from COALESCE(ts_hull_geom_3857, geom_3857)
      → geom_simplified_low = simplify_for_zoom(..., 5000m)
      → geom_simplified_medium = simplify_for_zoom(..., 1000m)
```

The simplified columns prefer the hull geometry when available, so tile rendering at low zoom shows the hull shape.

### Administrative divisions — 2 triggers

#### 1. `trigger_simplify_geom` (on INSERT or UPDATE OF geom)

```
update_simplified_geometries()
  → geom_simplified_low = ST_SimplifyPreserveTopology(geom, 0.1°)
  → geom_simplified_medium = ST_SimplifyPreserveTopology(geom, 0.01°)
```

Uses degree-based tolerance and topology-preserving simplification. These 4326 columns are used for GeoJSON API responses.

#### 2. `trg_admin_div_geom_3857` (on INSERT or UPDATE — any column)

```
update_admin_div_geom_3857()
  → geom_3857 = ST_Transform(geom, 3857)
  → geom_simplified_low_3857 = simplify_for_zoom(geom_3857, 5000m)
  → geom_simplified_medium_3857 = simplify_for_zoom(geom_3857, 1000m)
```

Uses meter-based tolerance via `simplify_for_zoom()` (same function as regions). These 3857 columns are used for Martin tiles.

> **Dual simplification paths**: Admin divisions have TWO sets of simplified columns. The 4326 versions use `ST_SimplifyPreserveTopology` (degree-based, preserves topology) for API responses. The 3857 versions use `simplify_for_zoom()` (meter-based, with small-island fallback) for tile rendering. Regions only have 3857 simplified columns (no 4326 simplified versions).

---

## Render geometry and tile functions

### Render geometry selection

The render geometry (what to draw on the map) is:

```
IF archipelago AND ts_hull_geom IS NOT NULL → ts_hull_geom
ELSE → geom
```

This logic is centralized in the `region_render_geom` database view.

### Martin tile functions

Six functions in `db/init/01-schema.sql` generate MVT tiles. All output `ST_AsMVT(tile, layer_name, 4096, 'geom', 'id')`.

#### Region tile functions (3 functions, same geometry selection)

`tile_world_view_root_regions`, `tile_region_subregions`, `tile_world_view_all_leaf_regions` all use identical geometry selection:

```sql
CASE
  WHEN z <= 2 AND geom_simplified_low IS NOT NULL
    THEN ST_SimplifyPreserveTopology(geom_simplified_low, 50000)  -- extra simplification
  WHEN z <= 4 AND geom_simplified_low IS NOT NULL
    THEN geom_simplified_low
  WHEN z <= 8 AND geom_simplified_medium IS NOT NULL
    THEN geom_simplified_medium
  WHEN is_archipelago AND ts_hull_geom_3857 IS NOT NULL
    THEN ts_hull_geom_3857
  ELSE geom_3857
END
```

MVT attributes: `id`, `name`, `color`, `is_archipelago`, `has_subregions`, `using_ts_hull`, `parent_region_id`, `world_view_id`.

Summary:

```
Zoom 0-2:  geom_simplified_low (extra-simplified at 50km)
Zoom 3-4:  geom_simplified_low
Zoom 5-8:  geom_simplified_medium
Zoom 9+:   ts_hull_geom_3857 (archipelagos), else geom_3857
```

#### Division tile functions (2 functions, same selection)

`tile_gadm_root_divisions`, `tile_gadm_subdivisions`:

```sql
CASE
  WHEN z <= 4 AND geom_simplified_low_3857 IS NOT NULL
    THEN geom_simplified_low_3857
  WHEN z <= 8 AND geom_simplified_medium_3857 IS NOT NULL
    THEN geom_simplified_medium_3857
  ELSE geom_3857
END
```

```
Zoom 0-4:  geom_simplified_low_3857
Zoom 5-8:  geom_simplified_medium_3857
Zoom 9+:   geom_3857
```

#### Island overlay function

`tile_region_islands` returns the **real geometry** (`geom_3857`) for archipelago regions that have a hull. This lets the frontend show actual island outlines at higher zoom while the hull provides the low-zoom shape. Filtered to `is_archipelago = true AND ts_hull_geom IS NOT NULL`.

---

## Antimeridian handling

The `update_region_focus_data()` trigger implements three-branch logic for computing `focus_bbox` and `anchor_point`:

### 1. Normal regions

Standard bbox from `ST_Envelope()`: `focus_bbox = [west, south, east, north]` where west < east.

### 2. Antimeridian-crossing regions (e.g., Fiji, Russia)

**Detection**: Compare normal bbox span vs shifted bbox span. `ST_ShiftLongitude()` moves negative coordinates to [180,360] range. If the shifted span is smaller than the normal span, the geometry crosses the antimeridian.

**Result**: `west > east` in `focus_bbox` (e.g., `[170, -20, -170, -10]` for Fiji). Anchor point computed in shifted [0,360] space, then normalized back to [-180,180].

### 3. Full-globe regions (e.g., Oceania)

**Detection**: normal bbox span > 350° longitude. The geometry wraps nearly all the way around.

**Computation**: Cannot use the geometry's own bbox. Instead, aggregates children's `focus_bbox` values in shifted [0,360] space:
```sql
SELECT MIN(shifted_west), MAX(shifted_east), MIN(south), MAX(north)
FROM child regions WHERE focus_bbox IS NOT NULL
```

If no children have focus data, falls back to normal bbox.

### Frontend handling

MapLibre's `cameraForBounds()` does NOT handle antimeridian correctly. The frontend (`RegionMapVT.tsx`) uses:
- Pre-computed `anchorPoint` as the map center
- Zoom computed from shifted bbox: if `west > east`, use `east + 360` to get the correct span in [0,360] space

See `docs/tech/maplibre-patterns.md` for additional MapLibre-specific patterns.

---

## Simplification strategy

Two simplification approaches are used, depending on the table and coordinate system:

### Admin divisions — 4326 (degree-based)

Trigger `update_simplified_geometries()` uses `ST_SimplifyPreserveTopology`:
- `geom_simplified_low`: 0.1° tolerance (world view)
- `geom_simplified_medium`: 0.01° tolerance (country view)

These preserve topology (no self-intersections) and use degree-based tolerance. Used for GeoJSON API responses (`/geometry?detail=low|medium`).

### Regions and admin divisions — 3857 (meter-based)

The `simplify_for_zoom()` function uses a three-stage pipeline:

1. **Stage 1 — Simplify**: `ST_Simplify` at requested tolerance (Douglas-Peucker, tolerance in meters), fix with `ST_MakeValid`, dump into individual polygons, drop polygons below `min_area`, re-collect into MultiPolygon
2. **Stage 2 — Fallback for small islands**: If Stage 1 produced NULL (geometry smaller than tolerance), retry with tolerance scaled to `max_polygon_width / 10`. This preserves small island regions like Aruba, Barbados, etc.
3. **Stage 3 — Smooth**: Apply `ST_ChaikinSmoothing` to round off the angular artifacts from Douglas-Peucker simplification (currently 0 passes for all tiers)

We use `ST_Simplify` instead of `ST_SimplifyPreserveTopology` because merged region geometries (composed of many country borders) create topology constraints that prevent vertex removal. `ST_Simplify` freely removes vertices, then `ST_MakeValid` repairs any self-intersections.

| Zoom tier | Table | Tolerance | Min polygon area | Chaikin passes |
|-----------|-------|-----------|-----------------|---------------|
| Low (0-4) | regions | 5,000m (5km) | 0 (no filter) | 0 |
| Low (0-4) | admin_div | 5,000m (5km) | 0 (no filter) | 0 |
| Medium (5-8) | regions | 1,000m (1km) | 0 (no filter) | 0 |
| Medium (5-8) | admin_div | 1,000m (1km) | 0 (no filter) | 0 |

---

## When each geometry is used

| Context | Table | Column(s) used |
|---------|-------|---------------|
| Martin vector tiles (zoom 0-2) | regions | extra-simplified `geom_simplified_low` |
| Martin vector tiles (zoom 3-4) | regions | `geom_simplified_low` |
| Martin vector tiles (zoom 0-4) | admin_div | `geom_simplified_low_3857` |
| Martin vector tiles (zoom 5-8) | regions | `geom_simplified_medium` |
| Martin vector tiles (zoom 5-8) | admin_div | `geom_simplified_medium_3857` |
| Martin vector tiles (zoom 9+) | regions | `ts_hull_geom_3857` (archipelagos), else `geom_3857` |
| Martin vector tiles (zoom 9+) | admin_div | `geom_3857` |
| Island overlay tiles | regions | `geom_3857` (real geometry for archipelagos) |
| GeoJSON API `/geometry?detail=low` | admin_div | `geom_simplified_low` (4326) |
| GeoJSON API `/geometry?detail=medium` | admin_div | `geom_simplified_medium` (4326) |
| GeoJSON API `/geometry?detail=high` | admin_div/regions | `geom` (4326) |
| Geometry computation (region merging) | both | `geom` (4326) |
| Camera fly-to (fitBounds) | regions | `focus_bbox` (array of 4 doubles) |
| Map labels | both | `anchor_point` (4326) |

## How geometries are maintained

- **GADM divisions**: Loaded by `db/init-db.py` which inserts `geom`. Trigger `trigger_simplify_geom` auto-computes 4326 simplified versions. Trigger `trg_admin_div_geom_3857` auto-computes all 3857 columns.
- **Regions**: Created/updated by the backend API when geometry is computed. Three triggers auto-compute metadata, focus data, and 3857/simplified columns.
- **Simplified columns**: Never written directly by application code. Always computed by triggers.

---

## Frontend consumption

Tile URL construction: `frontend/src/components/regionMap/useTileUrls.ts`

- Custom world views: `tile_world_view_all_leaf_regions` (root level), `tile_region_subregions` (drilled in)
- GADM: `tile_gadm_root_divisions` (root), `tile_gadm_subdivisions` (drilled in)
- Islands: `tile_region_islands` overlay for archipelagos
- All URLs include `_v={tileVersion}` for cache busting

Map rendering: `frontend/src/components/RegionMapVT.tsx` uses react-map-gl `<Source>`/`<Layer>` components with feature state for visited/selected/hover styling.

For MapLibre-specific patterns (fonts, feature IDs, paint priority, hover handling), see `docs/tech/maplibre-patterns.md`.
